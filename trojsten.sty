\NeedsTeXFormat{LaTeX2e}[2011/01/01]
\ProvidesPackage{trojsten}[2015/09/07 Trojsten unified TeX]

% Banish cslatex to eternal voids
% This package is currently only compatible with XeLaTeX

% Please use
% \SI{<how many>}{<what units>}, not \unit nor \mathrm and who knows what.
% \ang{10}, not 10^{\mathrm{\circ}} or whatever the hell you might have seen. It’s no longer 1997.
% \ang{1;2;3} for degrees, minutes, seconds: 1° 2’ 3”

% DO NOT COME UP WITH YOUR OWN HACKS.
% If anything does not work as you wish, feel free to contact me at kvik@fks.sk and we’ll find a solution.

\RequirePackage[
    paper                   = a4paper,
    left                    = 15mm,
    right                   = 15mm,
    top                     = 15mm,
    bottom                  = 15mm,
    headheight              = 16pt,
    headsep                 = 16pt,
    footskip                = 32pt,
    includeheadfoot,                                        % include header and footer dimensions in body
    %showframe                                               % uncomment this to see geometry frame
]{geometry}

\RequirePackage[
    separate-uncertainty,                                   % 7.2 ± 0.5
    multi-part-units        = single,
    per-mode                = reciprocal,                   % symbol for "m/s", reciprocal for "ms^{-1}"
    group-separator         = {\,},
    group-minimum-digits    = 3,
    inter-unit-product      = {\kern 0.10em},
    exponent-product        = \cdot,                        % \times for 5×10^7, \cdot for 5.1O^7    
    number-unit-product     = {\,},
    output-decimal-marker   = {,}
    %number-math-rm          = \ensuremath
]{siunitx}

\RequirePackage{
    amsmath,
    amssymb,
    xparse,
    enumitem,
    graphicx,
    listings,
    lastpage,
    calc,
    pdftexcmds,
    xifthen,
    hyperref,
    verbatim,
    color,
    float,
    booktabs,
    titlesec,
    afterpage,
    pgffor,
    fancyvrb                                                % fancy verbatim (currently unused)
}

\RequirePackage{fancyhdr}                                   % fancy header

\RequirePackage[all]{nowidow}

% Setup XeLaTeX-specific options

\RequirePackage{mathspec}                                   % includes fontspec
\RequirePackage{polyglossia}                                % multi-language support
\RequirePackage{xunicode}
\setdefaultlanguage{slovak}

% Setup fonts -- see fontspec/mathspec documentation.
% Fonts are loaded from .ttf and .otf files (instead of using system fonts)
\defaultfontfeatures{
    Mapping         = tex-text,
    Scale           = MatchLowercase,
    Ligatures       = Common
}

%\setallmainfonts[
%    Path            = fonts/ ,
%    Extension       = .otf ,
%    UprightFont     = *-regular ,
%    BoldFont        = *-bold ,
%    ItalicFont      = *-italic ,
%    BoldItalicFont  = *-bolditalic    
%]{agaramondpro}
\setallmainfonts[
    Path            = fonts/ ,
    Extension       = .otf ,
    UprightFont     = *-regular ,
    BoldFont        = *-bold ,
    ItalicFont      = *-it ,
    BoldItalicFont  = *-boldit    
]{minionpro}
\setmathsfont{Minion Math}                                  % change this
\setmonofont[
    Path            = fonts/ ,
    Extension       = .ttf ,
    UprightFont     = * ,
    BoldFont        = *b ,
    ItalicFont      = *i ,
    BoldItalicFont  = *z ,      
    Scale           = MatchLowercase,
]{consola}
\setsansfont[
    Path            = fonts/ ,
    Extension       = .ttf ,
    UprightFont     = * ,
    BoldFont        = *b ,
    ItalicFont      = *i ,
    BoldItalicFont  = *z    
]{verdana}

\RequirePackage{boolexpr}                                   % boolean expressions, switch

\input{trojsten-utils.sty}

% Miscellaneous formatting macros
\NewDocumentCommand{\uv}{+m}{\quotedblbase#1\textquotedblleft}
\NewDocumentCommand{\romanNumeral}{m}{\uppercase\expandafter{\romannumeral#1\relax}}
\NewDocumentCommand{\errorMessage}{+m}{\colorbox{red}{#1}}


% Internal commands
\NewDocumentCommand{\loadSeminar}{m}{
    \IfFileExists{trojsten-config-#1.sty}{
        \usepackage{trojsten-config-#1}                   
    }{
        \PackageError{trojsten}{Cannot load seminar #1}{File "trojsten-config-#1.sty" does not exist}
    }
}

% \Repeat
\ExplSyntaxOn
\cs_new_eq:NN \Repeat \prg_replicate:nn
\ExplSyntaxOff

\NewDocumentCommand{\Picture}{m m O{} O{}}{
    \begin{figure}[H]
        \centering
        \includegraphics[keepaspectratio = true, height = #2]{files/\seminarID/tasks/#1}
        \ifstrempty{#3}{}{\caption{\emph{#3}}}
        \ifstrempty{#4}{}{\label{#4}}
    \end{figure}
}

%\createTaskHeader{name, pointsDescription, pointsCode}
\NewDocumentCommand{\createTaskHeader}{O{} O{} O{}}{
    \subsection{
        \texorpdfstring{%
            \large \textbf{\ifstrequal{#1}{}{úloha}{#1}}%
            \hfill\normalsize%
            \formatTaskPoints[#2][#3]
            \quad
            \formatTaskCategories{\getTaskCategories{\value{taskNumber}}}%
        }{%
            \arabic{taskNumber}%
        }%
    }
}

%\createSolutionHeader{name, author, evaluator}
\NewDocumentCommand{\createSolutionHeader}{O{} O{} O{}}{
    \subsection{
        \texorpdfstring{%
            \large \textbf{\ifstrequal{#1}{}{úloha}{#1}}%
            \hfill\normalsize%
            \ifstrequal{#2}{}{%
                \ifstrequal{#3}{}{}{opravovalo \textbf{#3}}%
            }{%
                \ifstrequal{#3}{}{vzorák \textbf{#2}}{vzorák \textbf{#2}, opravovalo \textbf{#3}}%
            }%
        }{%
            \arabic{taskNumber}%
        }%
    }
}

\NewDocumentCommand{\addTasks}{}{%    
    \newcounter{taskNumber}
    \Repeat{\seminarTaskCount}{\tryAddTask}%
}

\NewDocumentCommand{\addSolutions}{}{%
    \newcounter{taskNumber}%
    \Repeat{\seminarTaskCount}{\tryAddSolution}%
}

\NewDocumentCommand{\tryAddTask}{}{
    \stepcounter{taskNumber}    
    \IfFileExists{files/\seminarID/tasks/task\arabic{taskNumber}}{%
        \input{files/\seminarID/tasks/task\arabic{taskNumber}}%
    }{%
        \errorMessage{<MISSING FILE \texttt{task\arabic{taskNumber}}!>}\\
    }    
}

\NewDocumentCommand{\tryAddSolution}{}{
    \stepcounter{taskNumber}
    \IfFileExists{files/\seminarID/solutions/task\arabic{taskNumber}}{%
        \input{files/\seminarID/solutions/task\arabic{taskNumber}}%
    }{%
        \errorMessage{<MISSING FILE \texttt{task\arabic{taskNumber}}!>}\\
    }    
}

% \exampleIO{verbatim input, verbatim output}
% this macro takes two verbatim 
% uses ExplSyntax (LaTeX3)
% primarily intended for KSP input and output examples
\ExplSyntaxOn
\char_set_catcode_other:n {`\^^M}
\NewDocumentCommand{\exampleIO}{+v +v}{
    \tl_set:Nn \l_tmpa_tl {#1}
    \tl_set:Nn \l_tmpb_tl {#2}
    \tl_replace_all:Nnn \l_tmpa_tl {^^M} {\par}
    \tl_replace_all:Nnn \l_tmpb_tl {^^M} {\par}
    
    \begin{minipage}[t]{0.48\linewidth}     
        \begin{center}vstup\end{center}
        \vspace{-15pt}                                              % one nasty hack here       
        \fbox{
            \begin{minipage}[t]{\linewidth}
                \mbox{}\\[-1.5\baselineskip]                        % another nasty hack here
                \ttfamily
                \l_tmpa_tl
            \end{minipage}
        }
    \end{minipage}
    
    \begin{minipage}[t]{0.0393\linewidth}
        \mbox{}
    \end{minipage}
    
    \begin{minipage}[t]{0.48\linewidth}
        \begin{center}výstup\end{center}
        \vspace{-15pt}                                              % guess what here
        \fbox{
            \begin{minipage}[t]{0.975\linewidth}
                \mbox{}\\[-1.5\baselineskip]                        % and one nasty hack here
                \ttfamily
                \l_tmpb_tl
            \end{minipage}
        }
    \end{minipage}
    \\[1ex]
}
\char_set_catcode_end_line:n{`\^^M}
\ExplSyntaxOff



\endinput                                                           % everything below is safely ignored

KNOWN ISSUES:
\num{0.5} typesets an ugly tall comma



