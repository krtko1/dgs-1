\NeedsTeXFormat{LaTeX2e}[2011/01/01]
\ProvidesPackage{dgs}[2016/11/10 Trojsten Document Generation System -- DeGeŠ]

% Document Generation System - skrátene DGS, čítaj DeGeŠ, chce nahradiť všetky existujúce
% spôsoby sádzania trojstenových zadaní, vzorákov a ostatných dokumentov.

% Prosíme o dodržiavanie nasledovných zásad.

% SI jednotky sa píšu pomocou balíčka siunitx. \SI{koľko}{čoho}. Žiadne \unit, \mathrm ani nič podobné.
% Ak ti stačí jednotka bez čísla, tak \si{jednotka}.
% Uhly sa takisto nepíšu ako v~roku 1997, ale používame makro \ang{90} alebo \ang{48;9;5}.
% Desatinné čísla sa dajú písať ako \num{4.7}, napríklad sa to automaticky
%	stará o slovenskú desatinnú čiarku miesto bodky.
% 


% NEVYMÝŠĽAJ VLASTNÉ HACKY, ŠPECIÁLNE NIE V PRÍPADE, ŽE TVOJ KÓD BUDE POUŽÍVAŤ AJ NIEKTO INÝ.
% Aj keď je TeX miestami nechutný, zatiaľ sa všetko podarilo spraviť +- čisto.

\RequirePackage[
    paper                   = a4paper,
    left                    = 15mm,
    right                   = 15mm,
    top                     = 15mm,
    bottom                  = 15mm,
    headheight              = 16pt,
    headsep                 = 16pt,
    footskip                = 32pt,
    includeheadfoot,                                        % započítať header a footer do rozmerov strany
    %showframe                                              % zobraziť frame
]{geometry}


\RequirePackage{
    amsmath,
    siunitx,
	xparse,
    enumitem,
    graphicx,
    listings,
    lastpage,
    marvosym,
    calc,
    pdftexcmds,
    xifthen,
    verbatim,
    color,
    float,
    caption,
    booktabs,
    titlesec,
    afterpage,
    pgffor,
    longtable,
	csvsimple,
	animate,
	skull,
    etoolbox,
    MnSymbol,
    fancyhdr,
	hyphenat,
    fancyvrb                                                % fancy verbatim (currently unused)
}

\captionsetup[figure]{
	format					= hang,
	width					= 0.9\textwidth,
}

\definecolor{colour-url}{RGB}{0, 137, 162}
\definecolor{colour-link}{RGB}{0, 137, 162}
\sisetup{
    separate-uncertainty,                                   % 7.2 ± 0.5
    detect-all              = true,                         % chceme zachovávať formátovanie prostredia
    multi-part-units        = single,                       % 12.3 ± 0.2 kg, neopakovať "kg"
    per-mode                = reciprocal,                   % symbol pre "m/s", reciprocal pre "ms^{-1}"
    group-separator         = {\,},
    group-minimum-digits    = 5,
    inter-unit-product      = {\kern 0.05em},               % veľmi tenká medzera medzi jednotkami
    exponent-product        = \cdot,                        % \times pre 5×10^7, \cdot pre 5.1O^7    
    number-unit-product     = {\,},                         % medzera medzi číslom a jednotkou
    output-decimal-marker   = {\text{,}},                   % v desatinných číslach chceme slovenskú čiarku
    range-units             = single,
    range-phrase            = {\text{--}},					% 5 -- 10 m/s
    list-units              = single,                       %
    list-final-separator    = {\ a\ },                      % 5, 7 a 10 m/s
}

\RequirePackage[
	colorlinks				= true,
	linkcolor				= colour-link,
	urlcolor				= colour-url,
]{hyperref}

\RequirePackage[e]{esvect}
\RequirePackage[all]{nowidow}

% Setup XeLaTeX-specific options

\RequirePackage{mathspec}                                   % includes fontspec
\RequirePackage{polyglossia}                                % multi-language support
\RequirePackage{xunicode}
\setdefaultlanguage{slovak}

% Disgusting hacks to bypass idiotic limitations of LaTeX -- 16 alphabets per document
\makeatletter
\NewDocumentCommand{\padzero}{m m}{\@anim@pad{#1}{#2}}

\def\new@mathgroup{\alloc@8\mathgroup\mathchardef\@cclvi}
\patchcmd{\document@select@group}{\sixt@@n}{\@cclvi}{}{}
\patchcmd{\select@group}{\sixt@@n}{\@cclvi}{}{}

\mathcode`\%="7025

\makeatother

% Setup fonts -- see fontspec/mathspec documentation.
% Fonty sa načítavajú zo súborov .ttf a .otf (v žiadnom prípade nepoužívame systémové fonty)
\defaultfontfeatures{
    Mapping         = tex-text,
    Scale           = MatchLowercase,
    Ligatures       = TeX
}
\setallmainfonts[
    Path            = core/fonts/ ,
    Extension       = .otf ,
    UprightFont     = *-r ,
    BoldFont        = *-b ,
    ItalicFont      = *-i ,
    BoldItalicFont  = *-bi    
]{minionpro}
\setmonofont[
	Path			= core/fonts/ ,
	Extension		= .ttf ,
	UprightFont     = *-r ,
    BoldFont        = *-b ,
    ItalicFont      = *-i ,
    BoldItalicFont  = *-bi    
]{ubuntumono}
\setsansfont[
    Path            = core/fonts/ ,
    Extension       = .ttf ,
    UprightFont     = *-r ,
    BoldFont        = *-b ,
    ItalicFont      = *-i ,
    BoldItalicFont  = *-bi    
]{verdana}

\makeatletter                                               % handler na chybu v mathspec, aby fonty v URL obsahovali monospace čísla
    \DeclareMathSymbol{0}{\mathalpha}{\eu@DigitsArabic@symfont}{`0}
    \DeclareMathSymbol{1}{\mathalpha}{\eu@DigitsArabic@symfont}{`1}
    \DeclareMathSymbol{2}{\mathalpha}{\eu@DigitsArabic@symfont}{`2}
    \DeclareMathSymbol{3}{\mathalpha}{\eu@DigitsArabic@symfont}{`3}
    \DeclareMathSymbol{4}{\mathalpha}{\eu@DigitsArabic@symfont}{`4}
    \DeclareMathSymbol{5}{\mathalpha}{\eu@DigitsArabic@symfont}{`5}
    \DeclareMathSymbol{6}{\mathalpha}{\eu@DigitsArabic@symfont}{`6}
    \DeclareMathSymbol{7}{\mathalpha}{\eu@DigitsArabic@symfont}{`7}
    \DeclareMathSymbol{8}{\mathalpha}{\eu@DigitsArabic@symfont}{`8}
    \DeclareMathSymbol{9}{\mathalpha}{\eu@DigitsArabic@symfont}{`9}
\makeatother

\RequirePackage{boolexpr}                                   % boolean expressions, switch
\RequirePackage{core/dgs-utils}

\NewDocumentCommand{\lang}{O{en} +m}{%
	\ifstrequals{#1}{\currentLanguage}{#2}{}%
}

% \romanNumeral{number}
% Rímske číslo
%   - číslo
\NewDocumentCommand{\romanNumeral}{m}{\uppercase\expandafter{\romannumeral#1\relax}}
\NewDocumentCommand{\errorMessage}{+m}{\colorbox{red}{#1}}
\NewDocumentCommand{\todoMessage}{+m}{\colorbox{cyan}{#1}}

\NewDocumentCommand{\loadDocumentSettings}{}{
	\IfFileExists{input/settings.tex}{
        \input{input/settings.tex}                   
    }{
        \PackageError{dgs}{Cannot load document settings}{File "input/settings.tex" does not exist}
    }

}

% Internal commands
\NewDocumentCommand{\loadSeminar}{m}{
    \IfFileExists{core/config/dgs-config-#1.sty}{
        \RequirePackage{core/config/dgs-config-#1}                   
    }{
        \PackageError{dgs}{Cannot load seminar #1}{File "dgs-config-#1.sty" does not exist}
    }
}

% \Repeat
\ExplSyntaxOn
\cs_new_eq:NN \Repeat \prg_replicate:nn
\ExplSyntaxOff

\NewDocumentCommand{\genderSwitch}{m m}{%
    \ifstrequal{\recipientGender}{male}{#1}{#2}%
}

\NewDocumentCommand{\currentProblem}{}{%
	\padzero{00}{\arabic{problem}}%
}

% \insertPicture{filename}{height}{caption}{label}
% Vloží obrázok s určenou výškou
%   - meno súboru, hľadá v aktuálnom priečinku
%   - prípona súboru
%   - prípona súboru pre HTML (ignoruje sa)
%   - výška obrázka (napríklad v mm)
%   - popis pod obrázkom
%   - label pre odkázanie sa na obrázok
\NewDocumentCommand{\insertPicture}{m m m m m m}{%
    \begin{figure}[H]%
        \centering%
        \IfFileExists{\rootDirectory/\currentProblem/#1.#2}{%
            \includegraphics[keepaspectratio = true, height = #4]{\rootDirectory/\currentProblem/#1}%
        }{%
            \includegraphics[keepaspectratio = true, height = #4]{example-image-a}%
        }%
        \ifstrempty{#5}{}{\caption{\textit{#5}}}%
        \ifstrempty{#6}{}{\label{#6}}%
    \end{figure}%
}

% \createProblemHeader[name][pointsDescription][pointsCode]
% Vytvorí novú hlavičku zadania úlohy
%   - názov úlohy
%   - počet bodov za popis (iba KSP)
%   - počet bodov za kód (iba KSP)
\NewDocumentCommand{\createProblemHeader}{m m m}{
    \subsection{
        \texorpdfstring{%
            \large \textbf{\ifstrequal{#1}{}{}{#1}}%
            \hfill\normalsize%
            \formatProblemPoints{#2}{#3}%
            \quad\formatProblemCategories{\getProblemCategories{\value{problem}}}%
        }{%
            \arabic{problem}%
        }%
    }
}

% \createSolutionHeader[name][author][evaluator][gender]
% Vytvorí novú hlavičku vzorového riešenia
%   - názov úlohy
%   - meno autora vzorového riešenia
%   - meno opravovateľa
%   - gramatický rod opravovateľa
\NewDocumentCommand{\createSolutionHeader}{m m m m}{
    \subsection{
        \texorpdfstring{%
            \large \textbf{\ifstrempty{#1}{úloha}{#1}}%
            \hfill\normalsize%
            \ifstrempty{#2}{%
                \ifstrempty{#3}{}{opravoval#4 \textbf{#3}}%
            }{%
                vzorák \textbf{#2}\ifstrempty{#3}{}{, opravoval#4 \textbf{#3}}%
            }%
        }{%
            \arabic{problem}%
        }%
    }
}

\NewDocumentCommand{\protectedInput}{m}{%
	\IfFileExists{#1}{%
        \input{#1}%
    }{%
        \errorMessage{<MISSING FILE \texttt{#1}!>}\\%
    }%
}

\NewDocumentCommand{\addProblems}{}{%   
	\setcounter{problem}{0}%
	\input{\rootDirectory/recipe-problems.tex}%
}

\NewDocumentCommand{\addProblem}{m m m}{%
	\stepcounter{problem}%
	\createProblemHeader{#1}{#2}{#3}%
	\protectedInput{\rootDirectory/\currentProblem/problem.tex}%
}

\NewDocumentCommand{\addSolutions}{}{%
	\setcounter{problem}{0}%
    \input{\rootDirectory/recipe-solutions.tex}%
}

\NewDocumentCommand{\addSolution}{m m m m}{%
	\stepcounter{problem}%
	\createSolutionHeader{#1}{#2}{#3}{#4}
%	{
%		\small\it
%		\protectedInput{\rootDirectory/\currentProblem/problem.tex}\par
%	}
	\protectedInput{\rootDirectory/\currentProblem/solution.tex}%
}

% \exampleIO[verbatim input][verbatim output]
% Príklad vstupu/výstupu (KSP)
%   - verbatim vstup
%   ₋ verbatim výstup
% Používa ExplSyntax z LaTeX3
\ExplSyntaxOn
\char_set_catcode_other:n {`\^^M}
\NewDocumentCommand{\exampleIO}{+v +v}{
    \tl_set:Nn \l_tmpa_tl {#1}
    \tl_set:Nn \l_tmpb_tl {#2}
    \tl_replace_all:Nnn \l_tmpa_tl {^^M} {\par}
    \tl_replace_all:Nnn \l_tmpb_tl {^^M} {\par}
    
    \begin{minipage}[t]{0.48\linewidth}     
        \begin{center}vstup\end{center}
        \vspace{-15pt}                                              % one nasty hack here       
        \fbox{
            \begin{minipage}[t]{\linewidth}
                \mbox{}\\[-1.5\baselineskip]                        % another nasty hack here
                \ttfamily
                \l_tmpa_tl
            \end{minipage}
        }
    \end{minipage}
    
    \begin{minipage}[t]{0.0393\linewidth}
        \mbox{}
    \end{minipage}
    
    \begin{minipage}[t]{0.48\linewidth}
        \begin{center}výstup\end{center}
        \vspace{-15pt}                                              % guess what here
        \fbox{
            \begin{minipage}[t]{0.975\linewidth}
                \mbox{}\\[-1.5\baselineskip]                        % and one nasty hack here
                \ttfamily
                \l_tmpb_tl
            \end{minipage}
        }
    \end{minipage}
    \\[1ex]
}
\char_set_catcode_end_line:n{`\^^M}
\ExplSyntaxOff



\endinput                                                           % everything below is safely ignored


